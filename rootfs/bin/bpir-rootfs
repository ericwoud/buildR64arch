#!/bin/bash

PACKAGES="build-r64-arch-utils-git hostapd-launch ssh-fix-reboot bpir-initrd ethtool-static-git hostapd-static-git"
TIMEZONE="Europe/Paris"
USERNAME="user"
USERPWD="admin"
ROOTPWD="admin"

while [ "${1:-}" != '' ]; do
  case "$1" in
  '-b' | '--bpirtoolbox') shift; bpirtoolbox="${1}"    ;;
         '--bpirtoolbox'=*)      bpirtoolbox="${1#*=}" ;;
  '-i' | '--brlanip')   shift;   brlanip="${1}"        ;;
         '--brlanip'=*)          brlanip="${1#*=}"     ;;
  '-d' | '--ddrsize')   shift;   ddrsize="${1}"        ;;
         '--ddrsize'=*)          ddrsize="${1#*=}"     ;;
  '-s' | '--setup')     shift;   setup="${1}"          ;;
         '--setup'=*)            setup="${1#*=}"       ;;
  '-t' | '--target')    shift;   target="${1}"         ;;
         '--target'=*)           target="${1#*=}"      ;;
  '-a' | '--device') shift;      device="${1}"      ;;
         '--device'=*)           device="${1#*=}"   ;;
  '-m' | '--menuonly')           menuonly=1            ;;
  '-c' | '--configonly')         configonly=1          ;;
  '-d' | '--cachedir')           cachedir=1            ;;
  '-S' | '--disable-sandbox')    disablesandbox=1      ;;
  *) cat <<-EOF
	Usage: $(basename "$0") [OPTION]...
	  -b --bpirtoolbox [ARGS]                 specify arguments for bpir-toolbox
	  -i --brlanip [IP]                       specify ip for brlan
	  -d --ddrsize [default|8]                specify ddr size
	  -s --setup [AP|RT|...]                  specify setup for network
	  -t --target [bpir64|bpir3|bpir3m|bpir4] specify target
	     --device [sdmmc|emmc|nvme|sata]      specify device
	  -S --disable-sandbox     disable pacman sandbox download
	  -m --menuonly            menu only
	  -c --configonly          setup the rootfs only
	EOF
    exit 1
    ;;
  esac
  shift
done

if [ -z "${target}" ] || [ -z "${device}" ]; then
  rootdev=$(lsblk -pilno name,type,mountpoint | grep -G 'part /$' | head -n1 | cut -d " " -f1)
  [ -z "$rootdev" ] && exit 1
  partlabelroot=$(blkid $rootdev -s PARTLABEL -o value)
  [ -z "$partlabelroot" ] && exit 1
  target=$(echo $partlabelroot    | cut -d'-' -f1)
  device=$(echo $partlabelroot | cut -d'-' -f2)
fi

case ${target} in
  bpir64)
    DDRSIZES=("default    1 GB")
    SETUPS=("RT       Router setup"
            "AP       Access Point setup")
    WIFIMODULE="mt7615e"
    ;;
  bpir3)
    DDRSIZES=("default    2 GB")
    SETUPS=("RT       Router setup, SFP module eth1 as wan"
            "RTnoSFP  Router setup, not using SFP module"
            "AP       Access Point setup")
    WIFIMODULE="mt7915e"
    ;;
  bpir3m)
    DDRSIZES=("default    2 GB")
    SETUPS=("RT       Router setup"
            "AP       Access Point setup")
    WIFIMODULE="mt7915e"
    ;;
  bpir4)
    DDRSIZES=("default    4 GB"
              "8          8 GB")
    SETUPS=("RTnoSFP  Router setup, not using SFP module, wan=lan0"
            "AP       Access Point setup")
    WIFIMODULE="mt7915e"
    ;;
  *)
    echo "Unknown target '${target}'"
    exit
    ;;
esac

if [ -z "$bpirtoolbox" ]; then
  case ${device} in
    sdmmc|emmc) bpirtoolbox="--fip2boot" ;;
    nand)       bpirtoolbox="--boot2fip" ;;
    nvme)       bpirtoolbox="--extlinux" ;;
    sata)       bpirtoolbox="--extlinux" ;;
    *) echo "Unknown device '${device}'" ;;
  esac
fi

function ask() {
  local a items count
  if [ -z "${!1}" ]; then
    eval 'items=("${'"${2}"'[@]}")'
    eval 'count=${#'"${2}"'[@]}'
    if [ ${count} -gt 1 ]; then
      PS3="${3} "; COLUMNS=1; echo
      select a in "${items[@]}" "Quit"; do
        (( REPLY > 0 && REPLY <= ${count} )) && break || exit 1
      done
    else
      a=${items[0]}
      echo -e "\n${3} $a"
    fi
    export declare $1=${a%% *}
  fi
}

if [ -z "$configonly" ]; then
    ask ddrsize DDRSIZES "Choose the size of ddr ram:"
    ask setup SETUPS "Choose setup to create root for:"
    if [ -z "$brlanip" ]; then
      read -p "Enter ip address for local network (emtpy for default): " brlanip
      [ -z "$brlanip" ] && brlanip="default"
      echo "IP="$brlanip
    fi
    if [ -n "$menuonly" ]; then
      echo -n "--setup '${setup}' --ddrsize '${ddrsize}' --brlanip '${brlanip}' --bpirtoolbox '${bpirtoolbox}'" >/tmp/bpir-rootfs.txt
    else
      read -p "Type <yes> to alter your rootfs! " prompt
      [[ $prompt != "yes" ]] && exit 1
    fi
fi

[ -n "$menuonly" ] && exit 0

function rootfs {
  PACKAGES+=" packages-${target}"
  if [ ! -f "/etc/arch-release" ]; then ### Ubuntu / Debian
    sshd="ssh"
    wheel="sudo"
    groups="audio,games,lp,video,$wheel"
    [ -n "$cachedir" ] && cdir="-o Dir::Cache::Archives=/cachedir" || cdir="--yes"
    until DEBIAN_FRONTEND=noninteractive apt-get update -q ${cdir} --yes
    do sleep 2; done
    until DEBIAN_FRONTEND=noninteractive apt-get install -q ${cdir} --yes $PACKAGES
    do sleep 2; done
  else # ArchLinuxArm
    sshd="sshd"
    wheel="wheel"
    groups="audio,games,log,lp,optical,power,scanner,storage,video,$wheel"
    [ -n "$cachedir" ]       && cdir="--cachedir=/cachedir" || cdir="--noconfirm"
    [ -n "$disablesandbox" ] && sb="--disable-sandbox"      || sb="--noconfirm"
    until pacman -Syyu --needed --noconfirm "${cdir}" "${sb}" $PACKAGES
    do sleep 2; done
  fi
  sync
  useradd --create-home --user-group \
               --groups ${groups} \
               -s /bin/bash $USERNAME
  echo "%${wheel} ALL=(ALL) ALL" | tee /etc/sudoers.d/wheel
  ln -sf /usr/share/zoneinfo/${TIMEZONE} /etc/localtime
  sed -i 's/.*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
  sed -i 's/.*UsePAM.*/UsePAM no/' /etc/ssh/sshd_config
  cp -rfvL "/usr/share/buildR64arch/etc" /
  wdir="/etc/systemd/network"; rm -rf $wdir/*
  cp -rfvL "/usr/share/buildR64arch/network/${target^^}-${setup}/"* $wdir
  wdir="/etc/hostapd";         rm -rf $wdir/*
  cp -rfvL "/usr/share/buildR64arch/hostapd/${target^^}/"* $wdir
  sed -i 's/\bdummy\b/PARTLABEL='${target}'-'${device}'-root/g' /etc/fstab
  if [[ "${brlanip}" == "default" ]]; then
    sed -i 's/Address=.*/Address='$brlanip'\/24/' /etc/systemd/network/10-brlan.network
  fi
  mkdir -p /etc/modules-load.d
  echo -e "# Load ${WIFIMODULE}.ko at boot\n${WIFIMODULE}" | \
           tee /etc/modules-load.d/${WIFIMODULE}.conf
#  echo "options mt7915e wed_enable=Y" | \
#           tee /etc/modprobe.d/mt7915e.conf
  echo $USERNAME:$USERPWD | chpasswd
  echo      root:$ROOTPWD | chpasswd
  sudo systemctl --force --no-pager reenable ${sshd}.service
  sudo systemctl --force --no-pager reenable systemd-timesyncd.service
  sudo systemctl --force --no-pager reenable systemd-resolved.service
  if [[ ${setup} == "RT"* ]]; then
    sudo systemctl --force --no-pager reenable nftables.service
  else
    sudo systemctl --force --no-pager disable nftables.service
  fi
  sudo systemctl --force --no-pager reenable systemd-networkd.service
  find -L "/etc/hostapd" -name "*.conf"| while read conf ; do
    conf=$(basename $conf); conf=${conf/".conf"/""}
    sudo systemctl --force --no-pager reenable hostapd@${conf}.service \
                 2>&1 | grep -v "is added as a dependency to a non-existent unit"
  done
  setupMACconfig
  if [[ "${ddrsize}" == "default" ]]; then
    rm -f /boot/bootcfg/ddrsize 2>/dev/null
  else
    echo -n "${ddrsize}" | tee /boot/bootcfg/ddrsize
  fi
  bpir-toolbox --target=${target} --device=${device} --atf $bpirtoolbox
  sync
}

function setupMACconfig {
  file="/etc/systemd/network/mac.txt"
  while [ ! -z "$(cat $file | grep 'aa:bb:cc:dd:ee:ff')" ]; do
    mac_read="$(cat $file | grep -m1 'aa:bb:cc:dd:ee:ff' | cut -d ' ' -f1)"
    mac=${mac_read::17}
    nr=${mac_read:18}
    [ -z "$nr" ] && nr=1
    first="aa:bb:cc"
    while [ ! -z "$(cat $file | grep $mac)" ]; do # make sure all macs are different
      mac=$first:$(printf %02x $(($RANDOM%256))):$(printf %02x $(($RANDOM%256)))
    done
    mac=$mac:$(printf %02x $(($RANDOM%256)) )
    mac=${mac::-2}$(printf %02x $(((16#${mac: -2}&-$nr)+0)))
    sed -i '0,/aa:bb:cc:dd:ee:ff/{s/aa:bb:cc:dd:ee:ff/'$mac'/}' $file
  done
}

rootfs

